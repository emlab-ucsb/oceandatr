---
title: "Selecting areas with offshoredatr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Selecting areas with offshoredatr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	comment = "#>"
)

devtools::load_all()
```

The `get_area()` function is used to generate an `sf` object of the area of interest. If you already have an `sf` object with your area of interest, you do not need to use `get_area()` and can use your existing object in place of an object returned by `get_area()`. However, if you do need to generate an area of interest, using this particular function can be a bit confusing if the desired area is not a well-defined EEZ. Here, we walk through a few examples to make this function a little bit easier to use and understand. 

In the back-end, `get_area()` uses the `mrp_get()` function from the [`mregions2`](https://lifewatch.github.io/mregions2/) package - the R package for Marine Regions. This database is quite extensive and has several options for querying areas. There are two things to keep in mind when querying from this database - the query type and the column of interest within that query. 

We can get an idea of the possible query types using the following: 

```{r possible query types, eval=FALSE}
mregions2::mrp_list[,c("title", "layer")]
```

```{r possible query types output, echo=FALSE}
knitr::kable(mregions2::mrp_list[,c("title", "layer")])
```


There are several options to choose from, so it might be worthwhile to do a little extra research to decide which layer is most likely to give you the results you desire. Attributes in the "layer" column can be used to inform the `query_type` in `get_area()`. From here, we can look at the list of possible column names to choose from. Let's use the "eez" option as the layer of interest and allow `show_column_options` to equal `TRUE`. 

```{r possible column names}
get_area(query_type = "eez", show_column_options = TRUE)
```

Each of these columns is a different type of identifier for ocean areas that we can choose from. A full explanation of what the columns mean can be found [here](https://marineregions.org/eezattribute.php). The column we choose depends on how we want to refer to the area that we choose. Perhaps the most common column we might use is "territory1", which allows us to provide a specific country name by which to query. For example, we can pull Australia's EEZ and plot the result: 

```{r country example - australia, fig.align= "center", fig.cap="Map of the Australian EEZ."}
# Grab the area
australia_eez <- get_area(area_name = "Australia", query_type = "eez", mregions_column = "territory1")

# Plot the result
ggplot2::ggplot() + 
  ggplot2::geom_sf(data = australia_eez) + 
  ggplot2::theme_void()
```

Alternatively, we might know the ISO3 code for a territory and wish to query the database that way; we would use the "iso_ter1" column to filter for the ISO3 code we desire. Below, we use the ISO3 code for Australia to grab the EEZ. 

```{r iso3 code example - australia, fig.align= "center", fig.cap="Map of the Australian EEZ."}
# Grab the area
australia_eez <- get_area(area_name = "AUS", query_type = "eez", mregions_column = "iso_ter1")

# Plot the result
ggplot2::ggplot() + 
  ggplot2::geom_sf(data = australia_eez) + 
  ggplot2::theme_void()
```

Of course, maybe we aren't memorizing ISO3 codes, but we would recognize the code that we wanted if we saw it in a list. We can get a list of possible values to choose from for each `mregions_column` by setting `show_value_options` to `TRUE`: 

```{r list of possible values in iso_ter1}
get_area(query_type = "eez", mregions_column = "iso_ter1", show_value_options =  TRUE)
```

There might be a project in which you need the area in the high seas. This is a little tricky, but easy if you know the codes. In this case, the `area_name` should be "63202", the `query_type` should be "high_seas", and the `mregions_column` should be "mrgid". There is only one option for the high seas area, and it returns the layer in its entirety. 

```{r high seas, fig.align= "center", fig.cap="Map of the high seas."}
# Grab the area
high_seas <- get_area(area_name = "63203", query_type = "high_seas", mregions_column = "mrgid")

# Plot the result
ggplot2::ggplot() + 
  ggplot2::geom_sf(data = high_seas) + 
  ggplot2::theme_void()
```

If you are only interested in a small section of the high seas, you can crop this layer to the appropriate extent. 

```{r crop high seas, fig.align= "center", fig.cap="Map of the high seas, cropped near Australia."}
sf::sf_use_s2(FALSE) # turn of spherical geometry so we can crop

# Crop the area
high_seas_cropped <- high_seas %>% 
  sf::st_crop(xmin = 100, xmax = 185, ymin = -60, ymax = 0)

# Plot the result
ggplot2::ggplot() + 
  ggplot2::geom_sf(data = high_seas_cropped) + 
  ggplot2::theme_void()
```

If your region of interest includes the high seas and an EEZ area, you can combine the two layers resulting from their independent queries using `sf::st_union()`. 

```{r australia eez and high seas, fig.align= "center", fig.cap="Map of the Australian EEZ and nearby high seas areas."}
# Combine the areas
australia_eez_high_seas <- australia_eez %>% 
  sf::st_union(high_seas_cropped)

# Plot the result
ggplot2::ggplot() + 
  ggplot2::geom_sf(data = australia_eez_high_seas) + 
  ggplot2::theme_void()
```

Currently, there is no way to select multiple areas at once. If your region of interest spans several EEZs or marine regions, we recommend querying each area independently and merging the layers together.

```{r australia and indonesia, fig.align= "center", fig.cap="Map of the Indonesian and Australian EEZs."}
# Grab the area
indonesia_eez <- get_area(area_name = "Indonesia", query_type = "eez", mregions_column = "territory1")

# Combine the areas
australia_indonesia <- australia_eez %>% 
  sf::st_union(indonesia_eez)

# Plot the result
ggplot2::ggplot() + 
  ggplot2::geom_sf(data = australia_indonesia) + 
  ggplot2::theme_void()
```

We can now go ahead and use these areas in `offshoredatr` to create an appropriate planning grid and grab additional datasets. 

```{r proceed with offshoredatr setup, fig.align= "center", fig.cap="Planning grid of the Indonesian and Australian EEZs."}
# Set projection for planning grid - grabbed from this website: https://projectionwizard.org
projection <- 'PROJCS["ProjWiz_Custom_Albers",
 GEOGCS["GCS_WGS_1984",
  DATUM["D_WGS_1984",
   SPHEROID["WGS_1984",6378137.0,298.257223563]],
  PRIMEM["Greenwich",0.0],
  UNIT["Degree",0.0174532925199433]],
 PROJECTION["Albers"],
 PARAMETER["False_Easting",0.0],
 PARAMETER["False_Northing",0.0],
 PARAMETER["Central_Meridian",135],
 PARAMETER["Standard_Parallel_1",-45.850866],
 PARAMETER["Standard_Parallel_2",3.0571749],
 PARAMETER["Latitude_Of_Origin",-21.3968456],
 UNIT["Meter",1.0]]'

# Create a planning grid 
planning_grid <- get_planning_grid(area_polygon = australia_indonesia, 
                                   projection_crs = projection, 
                                   resolution_km = 10)

# Plot the planning grid
terra::plot(planning_grid, box = FALSE, axes = FALSE, legend = FALSE)
```
```{r proceed with offshoredatr data, fig.align= "center", fig.cap="Seamounts within the Indonesian and Australian EEZs."}
# Get seamount locations with a 30 km buffer
seamounts <- get_seamounts_buffered(area_polygon = australia_indonesia, 
                                planning_grid = planning_grid, 
                                buffer_km = 30)
# Plot seamount data
terra::plot(seamounts, box = FALSE, axes = FALSE, legend = FALSE)
```



